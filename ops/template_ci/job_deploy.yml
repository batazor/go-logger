.job_template_deploy: &job_deploy
  type: deploy
  variables:
    GIT_STRATEGY: none
  script:
  - export DEPLOYS=$(helm ls | grep $RELEASE_NAME | wc -l)
  - if [ ${DEPLOYS}  -eq 0 ]; then
      helm --kube-context $HELM_NAMESPACE install
        --name $RELEASE_NAME
        --namespace=$CI_PROJECT_NAMESPACE
        --set CI_PROJECT_NAME=$CI_PROJECT_NAME
        --set CI_PIPELINE_ID=$CI_PIPELINE_ID
        --set CI_BUILD_ID=$CI_BUILD_ID
        --set image.tag=$CI_COMMIT_TAG
        --set CI_COMMIT_SHA=$CI_COMMIT_SHA
        $HELM_PATH;
    else
      helm --kube-context $HELM_NAMESPACE upgrade $RELEASE_NAME $HELM_PATH
        --namespace=$CI_PROJECT_NAMESPACE
        --set CI_PROJECT_NAME=$CI_PROJECT_NAME
        --set CI_PIPELINE_ID=$CI_PIPELINE_ID
        --set CI_BUILD_ID=$CI_BUILD_ID
        --set image.tag=$CI_COMMIT_TAG
        --set CI_COMMIT_SHA=$CI_COMMIT_SHA;
    fi
  except:
  - branches
  when: manual
